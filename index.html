<!DOCTYPE html>
<html lang="end">
<head>
  <meta charset="UTF-8">
  <title>Trivia</title>

  <style>

    body {
        background: #eee;
        font-family: Roboto, Arial;
        margin: 40px;
    }

    h1 {
        background: white;
        text-align: center;
    }

    h2 {
        text-align: center;
    }

    .screen {
        display: none;
    }

    .avatar-sm, .avatar-md {
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: inline-block;
        text-align: center;
    }

    .avatar-sm {
        height: 90px;
        margin: 10px;
        padding: 10px;
        text-align: center;
        width: 90px;
    }

    .avatar-sm img {
        width: 64px;
    }

    .avatar-md {
        display: inline-block;
        height: 150px;
        margin: 10px;
        padding: 10px;
        width: 120px;
    }

    .avatar-md img {
        width: 96px;
    }

    .avatar-sm div {
    }

    #team-data-chooser {
    }

    #welcome {
    }

    #welcome .avatar-sm {
        cursor: pointer;
    }

    #welcome .avatar-sm:hover {
        border: 1px solid #007cff;
    }

    #roster {
        display: flex;
        flex-direction: row;
    }

    .score {
        font-size: 120%;
        font-weight: bold;
    }

    #guess {
        font-size: xx-large;
    }

  </style>
</head>
<body onload="init()">

  <div id="loading" class="screen">Loading...</div>

  <div id="team-data-chooser" class="screen">
    <input type="file" id="team-data-file-input" />
  </div>

  <div id="welcome" class="screen">
    <h2>Welcome! Please tell me who you are ðŸ˜ƒ</h2>
  </div>

  <div id="board" class="screen">
    <div id="roster"></div>
    <div><input id="guess" /></div>
  </div>

  <script>
    let clientId;
    let team;
    let myLdap;
    let ws = new WebSocket('ws://' + window.location.hostname + ':7071');
    ws.onmessage = handleMessage;


    function selectScreen(screenId) {
      const screenEls = document.querySelectorAll('.screen');

      for (let i = 0, screen; screen = screenEls[i]; i++) {
        if (screen.getAttribute('id') === screenId) {
          screen.style.display = 'block';
        } else {
          screen.style.display = 'none';
        }
      }
    }

    function init() {
      selectScreen('loading');
    }

    function getAvatar(ldap, size) {
      let personEl = document.createElement('div');
      personEl.setAttribute('data', ldap);
      let avatarEl = document.createElement('img');
      personEl.classList.add('avatar-' + size);
      let nameEl = document.createElement('div');
      nameEl.textContent = team[ldap].name;
      avatarEl.setAttribute('src',
                            'data:image/png;base64,' + team[ldap].avatar);
      personEl.appendChild(avatarEl);
      personEl.appendChild(nameEl);
      return personEl;
    }
    function renderTeamDataChooser() {
      selectScreen('team-data-chooser');
      const chooserEl = document.getElementById('team-data-chooser');
      chooserEl.addEventListener('change', function(e) {

        var file = e.target.files[0];
        if (!file) {
          return;
        }
        var reader = new FileReader();
        reader.onload = function(e) {
          let contents = e.target.result;
          let message = {
            'method': 'team',
            'payload': contents
          }
          ws.send(JSON.stringify(message));
        };
        reader.readAsText(file);

        chooserEl.style.display = 'none';
      }, false);
    }

    function renderWelcome() {
      selectScreen('welcome');
      const welcomeEl = document.getElementById('welcome');
      welcomeEl.style.display = 'block';

      let ldaps = Object.keys(team);
      for (let i = 0; i < ldaps.length; i++) {
        const ldap = ldaps[i];
        let personEl = getAvatar(ldap, 'sm');
        welcomeEl.appendChild(personEl);
        personEl.onclick = function(e) {
          myLdap = ldap;
          ws.send(JSON.stringify({
            'method': 'whoami',
            'payload': ldap,
          }));
        }
      }
    }

    function renderRoster(scores) {
      let rosterEl = document.getElementById('roster');
      rosterEl.innerHTML = '';
      let ldaps = Object.keys(scores);
      console.log(ldaps);
      for (let ldap of ldaps.sort()) {
        let avatar = getAvatar(ldap, 'md');
        let scoreEl = document.createElement('div');
        scoreEl.textContent = scores[ldap];
        scoreEl.classList.add('score');
        avatar.appendChild(scoreEl);
        rosterEl.appendChild(avatar);
      }
    }

    function renderBoard(scores) {
      selectScreen('board');
      renderRoster(scores);
    }

    function handleMessage(message) {
      console.log('Message from server');
      const response = JSON.parse(message.data);
      if (response.method === 'connect') {
        clientId = response.clientId;
        console.log('I am client ' + clientId);
        console.log(response);
        if (!!response.team) {
          team = response.team;
          renderWelcome();
        } else {
          if (response.master) {
            renderTeamDataChooser();
          }
        }
      }
      if (response.method === 'board') {
        renderBoard(response.scores);
      }
    }

  </script>

</body>
</html>
